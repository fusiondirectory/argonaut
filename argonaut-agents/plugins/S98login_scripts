#NAME:Running user defined login scripts
# Include support library and configuration
. /usr/lib/argonaut/argonaut-support.lib
. /etc/argonaut/argonaut-agent.conf

prepare_script()
{
	name=$(echo $1 | cut -d\| -f1)
	flags=$(echo $1 | cut -d\| -f2)
	prio=$(echo $1 | cut -d\| -f3)
	data=$(echo $1 | cut -d\| -f4)
	name=$(printf '%0.2d-%s\n' $prio $name)	

	# Overwritable?
	if [ -f ~/.argonaut/scripts/$name ]; then
		echo $flags | grep -q O && echo $data | base64 -d | recode -f 'dos..latin1' > ~/.argonaut/scripts/$name
		echo -e "\n#FLAGS[$flags]" >> ~/.argonaut/scripts/$name
	else
		echo $data | base64 -d | recode -f 'dos..latin1'  > ~/.argonaut/scripts/$name
		echo -e "\n#FLAGS[$flags]" >> ~/.argonaut/scripts/$name
	fi
	chmod +x ~/.argonaut/scripts/$name
}


# Cleanup script space
[ -d ~/.argonaut/scripts ] && rm -rf ~/.argonaut/scripts
mkdir -p ~/.argonaut/scripts
LAST=0

# Read group based informations
if [ $(ldap_count "(&(memberUid=$USER)(objectClass=gotoEnvironment)(objectClass=posixGroup))") -gt 0 ]; then
	
	# Get list of group cn's
	cn=$(ldapsearch -x -b "$LDAP_BASE" "(&(memberUid=$USER)(objectClass=gotoEnvironment)(objectClass=posixGroup))" cn | grep '^cn: ' | fix_ldif | cut -d\  -f2-)
	
	for group in $cn; do
		ldapsearch -x -b "$LDAP_BASE" "(&(cn=$group)(objectClass=gotoEnvironment)(objectClass=posixGroup)(gotoLogonScript=*))" | fix_ldif | awk '/gotoLogonScript:/ { print $2 }' | while read line; do
			prepare_script "$line"
		done
	done
fi

# Read user based informations
if [ $(ldap_count "(&(uid=$USER)(objectClass=gotoEnvironment)(gotoLogonScript=*))") -eq 1 ]; then
	ldapsearch -x -b "$LDAP_BASE" "(&(uid=$USER)(objectClass=gotoEnvironment)(gotoLogonScript=*))" | fix_ldif | awk '/gotoLogonScript:/ { print $2 }' | while read line; do
		prepare_script "$line"
	done
fi

# Execute scripts
for i in $HOME/.argonaut/scripts/*; do
	[ "$i" == "$HOME/.argonaut/scripts/*" ] && break
	echo "Executing user logon script '$i'"
	$i
	if grep -q '#FALGS\[.*O.*]' $i; then
		echo "Reached last script, stopping here"
		break
	fi
done

# Cleanup
[ -d ~/.argonaut/scripts ] && rm -rf ~/.argonaut/scripts

